name: Azure Static Web Apps CI/CD

on:
  push:
    branches: [main]
  pull_request:
    types: [opened, synchronize, reopened, closed]
    branches: [main]

env:
  DOTNET_VERSION: '9.0.x'

jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # ãƒ“ãƒ«ãƒ‰ï¼†ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£ãƒ†ã‚¹ãƒˆï¼ˆPRã”ã¨ã«å®Ÿè¡Œï¼‰
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  build_and_test:
    if: github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.action != 'closed')
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Restore & Build
        run: dotnet build

      - name: Publish Blazor WASM
        run: dotnet publish BlazorA11yDemo.Client -c Release -o ./publish

      - name: Verify publish output
        run: |
          echo "=== Publish output contents ==="
          ls -la ./publish/wwwroot/
          echo "=== Checking index.html (first 20 lines) ==="
          head -20 ./publish/wwwroot/index.html

      - name: Install Playwright
        run: pwsh BlazorA11yDemo.Tests/bin/Debug/net9.0/playwright.ps1 install chromium --with-deps

      - name: Start HTTP Server
        run: |
          # npx serveã§Blazor WASMã‚’ã‚µãƒ¼ãƒ–ï¼ˆãƒãƒ¼ãƒˆ4280ï¼‰
          echo "Starting HTTP server on port 4280..."
          npx --yes serve ./publish/wwwroot -l 4280 &
          SERVER_PID=$!
          echo "Server PID: $SERVER_PID"
          
          # ã‚µãƒ¼ãƒãƒ¼èµ·å‹•ã‚’å¾…æ©Ÿ
          echo "Waiting for server to start..."
          for i in {1..30}; do
            if curl -s -o /dev/null -w "%{http_code}" http://localhost:4280 | grep -q "200"; then
              echo "âœ… Server is ready! (attempt $i)"
              break
            fi
            echo "Waiting... (attempt $i)"
            sleep 1
          done
          
          # æœ€çµ‚ç¢ºèª
          curl -I http://localhost:4280 || echo "âš ï¸ Server may not be fully ready"

      - name: Run Accessibility Tests
        id: a11y_test
        continue-on-error: true  # ãƒ†ã‚¹ãƒˆå¤±æ•—ã§ã‚‚CIã‚’æ­¢ã‚ãªã„
        run: |
          dotnet test BlazorA11yDemo.Tests --no-build \
            --logger "trx;LogFileName=results.trx" \
            --logger "console;verbosity=detailed" \
            2>&1 | tee test-output.txt
          echo "TEST_EXIT_CODE=$?" >> $GITHUB_ENV
        env:
          BaseUrl: 'http://localhost:4280'

      - name: Generate Test Summary
        if: always()
        run: |
          echo "## â™¿ ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£ãƒ†ã‚¹ãƒˆçµæœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f test-output.txt ]; then
            # ãƒ†ã‚¹ãƒˆçµæœã‹ã‚‰é•åã‚’æŠ½å‡º
            if grep -q "ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£é•å" test-output.txt; then
              echo "### âš ï¸ é•åãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              grep -A 50 "ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£é•å" test-output.txt | head -100 >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
            elif grep -q "Passed:" test-output.txt; then
              echo "### âœ… ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆã«åˆæ ¼ã—ã¾ã—ãŸ" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              grep "Passed:" test-output.txt >> $GITHUB_STEP_SUMMARY
            elif grep -q "ERR_CONNECTION_REFUSED" test-output.txt; then
              echo "### âŒ ã‚µãƒ¼ãƒãƒ¼æ¥ç¶šã‚¨ãƒ©ãƒ¼" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "ãƒ†ã‚¹ãƒˆã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã§ãã¾ã›ã‚“ã§ã—ãŸã€‚" >> $GITHUB_STEP_SUMMARY
            else
              echo "### ğŸ“‹ ãƒ†ã‚¹ãƒˆå‡ºåŠ›" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              tail -50 test-output.txt >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "ãƒ†ã‚¹ãƒˆå‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ“ [è©³ç´°ãªãƒ†ã‚¹ãƒˆçµæœã¯Artifactsã‚’ç¢ºèªã—ã¦ãã ã•ã„](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY

      - name: Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: accessibility-results
          path: |
            BlazorA11yDemo.Tests/TestResults/
            test-output.txt

      - name: Upload publish output for deploy
        uses: actions/upload-artifact@v4
        with:
          name: publish-output
          path: ./publish/wwwroot/

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Static Web Appsã¸ãƒ‡ãƒ—ãƒ­ã‚¤
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deploy:
    if: github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.action != 'closed')
    runs-on: ubuntu-latest
    needs: build_and_test
    name: Deploy to SWA
    
    steps:
      - uses: actions/checkout@v4

      - name: Download publish output
        uses: actions/download-artifact@v4
        with:
          name: publish-output
          path: ./publish/wwwroot/

      - name: Build And Deploy
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN }}
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          action: "upload"
          app_location: "./publish/wwwroot"
          skip_app_build: true

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # PRã‚¯ãƒ­ãƒ¼ã‚ºæ™‚ã«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç’°å¢ƒã‚’å‰Šé™¤
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  close_pull_request:
    if: github.event_name == 'pull_request' && github.event.action == 'closed'
    runs-on: ubuntu-latest
    name: Close Pull Request
    
    steps:
      - name: Close Pull Request
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN }}
          action: "close"
